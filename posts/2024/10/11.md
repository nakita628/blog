---
date: 2024-10-18
title: HonoX Prisma
description: HonoX Prisma „Å´„Çà„ÇãË©¶„Åø
tags: 
    - HonoX
    - Hono
    - Prisma
    - Zod OpenAPI

prev:
    text: Deno React Hono Start
    link: /posts/2024/10/10
next:
    text: npm workspace
    link: /posts/2024/10/12
---

# HonoX Prisma

&emsp;HonoX„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÁ´ã„Å°‰∏ä„Åí„Çã„ÄÇ

:::code-group
```sh [yarn]
yarn create hono
```
:::

&emsp;API„Çí‰ΩúÊàê„Åó„ÄÅUI„Å´Ë°®Á§∫„Åï„Åõ„Çã„ÄÇ

## Directory Structure
```
.
‚îú‚îÄ‚îÄ app
‚îÇ   ‚îú‚îÄ‚îÄ client.ts
‚îÇ   ‚îú‚îÄ‚îÄ global.d.ts
‚îÇ   ‚îú‚îÄ‚îÄ islands
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.tsx
‚îÇ   ‚îú‚îÄ‚îÄ routes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ _404.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ _error.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ _renderer.tsx
‚îÇ   ‚îî‚îÄ‚îÄ server.ts
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ public
‚îÇ   ‚îî‚îÄ‚îÄ favicon.ico
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ vite.config.ts
‚îî‚îÄ‚îÄ wrangler.toml
```

## HonoX RPC

&emsp;Á∞°Âçò„Å™API„Çí‰ΩúÊàê„Åô„Çã„ÄÇ

:::code-group
```ts [app/routes/api.ts]
import { createRoute, OpenAPIHono } from '@hono/zod-openapi'
import { z } from '@hono/zod-openapi'
import { hc } from 'hono/client'

export const honoSchema = z.object({
  message: z.string().openapi({
    example: 'HonoXüî•',
  }),
})

const app = new OpenAPIHono()

export const route = app.openapi(
  createRoute({
    method: 'get',
    path: '/honox',
    responses: {
      200: {
        content: {
          'application/json': {
            schema: honoSchema,
          },
        },
        description: 'HonoXüî•',
      },
    },
  }),
  (c) => {
    return c.json({ message: 'HonoXüî•' })
  },
)

export type AddType = typeof route
export const client = hc<AddType>('/api')
export default app
```
:::

&emsp;[RPC](https://hono.dev/docs/guides/rpc)„Çí‰ΩøÁî®„ÄÇ

:::code-group
```tsx [app/islands/index.tsx]
import { useState } from 'hono/jsx'
import { client } from '../routes/api'

const HonoXIslands = () => {
  const [message, setMessage] = useState('')

  const onSubmit = async () => {
    const res = await client.honox.$get()
    const data = await res.json()
    setMessage(data.message)
  }

  return (
    <>
      <h1>RPC</h1>
      <button onClick={onSubmit}>Get Message</button>
      <h1>{message}</h1>
    </>
  )
}

export default HonoXIslands
```
:::

## Prisma

:::code-group
```sh [yarn]
yarn add prisma --dev
```
:::

:::code-group
```sh [yarn]
yarn add @prisma/client
```
:::

## Zod Prisma

* [Zod Prisma](https://github.com/CarterGrimmeisen/zod-prisma)

:::code-group
```sh [yarn]
yarn add -D zod-prisma
```
:::

:::code-group
```prisma [prisma/schema.prisma]
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// schema„Éï„Ç°„Ç§„É´„Åã„Çâ„ÄÅZod„Çπ„Ç≠„Éº„Éû„ÇíÁîüÊàê„Åô„Çã
generator zod {
  provider              = "zod-prisma"
  output                = "../app/zod/prisma/"
  relationModel         = true
  modelCase             = "camelCase"
  modelSuffix           = "Schema"
  useDecimalJs          = true
  prismaJsonNullability = true
}

model Post {
  /// „Éù„Çπ„Éà„ÅÆ‰∏ÄÊÑè„ÅÆID
  /// @default {Generated by database}
  /// @zod.uuid()
  id        String   @id @default(uuid())
  /// „Éù„Çπ„Éà„ÅÆÂÜÖÂÆπ
  /// @zod.min(1) 
  /// @zod.max(140)
  post      String
  /// „Éù„Çπ„Éà„Åå‰ΩúÊàê„Åï„Çå„ÅüÊó•ÊôÇ
  createdAt DateTime @default(now())
  /// „Éù„Çπ„Éà„ÅåÊúÄÂæå„Å´Êõ¥Êñ∞„Åï„Çå„ÅüÊó•ÊôÇ
  updatedAt DateTime @updatedAt
}
```
:::


## Migrate

:::code-group
```sh [yarn]
yarn prisma migrate dev --name init
```
:::

## Generate
:::code-group
```sh [yarn]
yarn prisma generate
```
:::

## Directory Structure
```
.
‚îú‚îÄ‚îÄ app
‚îÇ   ‚îú‚îÄ‚îÄ client.ts
‚îÇ   ‚îú‚îÄ‚îÄ global.d.ts
‚îÇ   ‚îú‚îÄ‚îÄ islands
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.tsx
‚îÇ   ‚îú‚îÄ‚îÄ routes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ _404.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ _error.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ _renderer.tsx
‚îÇ   ‚îú‚îÄ‚îÄ server.ts
‚îÇ   ‚îî‚îÄ‚îÄ zod
‚îÇ       ‚îú‚îÄ‚îÄ honox
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ       ‚îî‚îÄ‚îÄ prisma
‚îÇ           ‚îú‚îÄ‚îÄ index.ts
‚îÇ           ‚îî‚îÄ‚îÄ post.ts
‚îú‚îÄ‚îÄ Makefile
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ prisma
‚îÇ   ‚îú‚îÄ‚îÄ dev.db
‚îÇ   ‚îú‚îÄ‚îÄ dev.db-journal
‚îÇ   ‚îú‚îÄ‚îÄ migrations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ *_init
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migration.sql
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migration_lock.toml
‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma
‚îú‚îÄ‚îÄ public
‚îÇ   ‚îî‚îÄ‚îÄ favicon.ico
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ vite.config.ts
‚îî‚îÄ‚îÄ wrangler.toml
```

&emsp;Zod„ÅåËá™Âãï„ÅßÁîüÊàê„Åï„Çå„Åæ„Åô„ÄÇ

:::code-group
```ts [app/zod/prisma/post.ts]
import * as z from 'zod'

export const postSchema = z.object({
  /**
   * „Éù„Çπ„Éà„ÅÆ‰∏ÄÊÑè„ÅÆID
   * @default {Generated by database}
   */
  id: z.string().uuid(),
  /**
   * „Éù„Çπ„Éà„ÅÆÂÜÖÂÆπ
   */
  post: z.string().min(1).max(140),
  /**
   * „Éù„Çπ„Éà„Åå‰ΩúÊàê„Åï„Çå„ÅüÊó•ÊôÇ
   */
  createdAt: z.date(),
  /**
   * „Éù„Çπ„Éà„ÅåÊúÄÂæå„Å´Êõ¥Êñ∞„Åï„Çå„ÅüÊó•ÊôÇ
   */
  updatedAt: z.date(),
})
```
:::

## Zod OpenAPI

&emsp;[Zod OpenAPI](https://hono.dev/examples/zod-openapi)„Å®ÁµÑ„ÅøÂêà„Çè„Åõ„Åæ„Åô„ÄÇ

## Directory Structure

```
‚îú‚îÄ‚îÄ app
‚îÇ   ‚îú‚îÄ‚îÄ client.ts
‚îÇ   ‚îú‚îÄ‚îÄ components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Button
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Error
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Post
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PostForm.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PostView.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Title
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ index.tsx
‚îÇ   ‚îú‚îÄ‚îÄ core
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ domain
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ posts_domain.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handler
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ honox_handler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ posts_handler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ swagger_handler.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ infra
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prisma.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ openapi
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ honox
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ posts
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ service
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ posts_service.ts
‚îÇ   ‚îú‚îÄ‚îÄ global.d.ts
‚îÇ   ‚îú‚îÄ‚îÄ islands
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ post_hooks.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ post
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ index.tsx
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ PostFormIslands.tsx
‚îÇ   ‚îú‚îÄ‚îÄ routes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ _404.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ _error.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ _renderer.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tweet
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ index.tsx
‚îÇ   ‚îú‚îÄ‚îÄ server.ts
‚îÇ   ‚îú‚îÄ‚îÄ styles
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îú‚îÄ‚îÄ types
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ props.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ state.ts
‚îÇ   ‚îú‚îÄ‚îÄ utils
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ post_utils.ts
‚îÇ   ‚îî‚îÄ‚îÄ zod
‚îÇ       ‚îú‚îÄ‚îÄ honox
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ       ‚îî‚îÄ‚îÄ prisma
‚îÇ           ‚îú‚îÄ‚îÄ index.ts
‚îÇ           ‚îî‚îÄ‚îÄ post.ts
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ prisma
‚îÇ   ‚îú‚îÄ‚îÄ dev.db
‚îÇ   ‚îú‚îÄ‚îÄ migrations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ *_init
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migration.sql
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migration_lock.toml
‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma
‚îú‚îÄ‚îÄ public
‚îÇ   ‚îî‚îÄ‚îÄ favicon.ico
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ vite.config.ts
‚îî‚îÄ‚îÄ wrangler.toml
```

:::code-group 
```ts [[app/core/openapi/index.ts]]
import { honox } from './honox'
import { posts } from './posts'

export const routes = {
  ...honox,
  ...posts,
}
```
:::

:::details honox
:::code-group
```ts [app/core/openapi/honox/index.ts]
import { createRoute } from '@hono/zod-openapi'
import { honoxSchema } from '../../../zod/honox'

export const honox = {
  HonoX: createRoute({
    tags: ['HonoX'],
    method: 'get',
    path: '/honox',
    responses: {
      200: {
        description: 'HonoXüî•',
        content: {
          'application/json': {
            schema: honoxSchema,
          },
        },
      },
    },
  }),
}
```
:::

:::details posts
:::code-group
```ts [app/core/openapi/posts/index.ts]
import { createRoute, z } from '@hono/zod-openapi'
import { postSchema } from '../../../zod/prisma'

// 201 Created
const createdResponse = {
  201: {
    description: 'Created',
    content: {
      'application/json': {
        schema: z.object({
          message: z.string().openapi({
            example: 'Created',
          }),
        }),
      },
    },
  },
}

// 204 No Content
const NoContentResponse = {
  204: {
    description: 'No Content',
  },
}

// 400 Bad Request
const badRequestResponse = {
  400: {
    description: 'Bad Request',
    content: {
      'application/json': {
        schema: z.object({
          message: z.string().openapi({
            example: 'Bad Request',
          }),
        }),
      },
    },
  },
}

// 500 Internal Server Error
const internalServerErrorResponse = {
  500: {
    description: 'Internal Server Error',
    content: {
      'application/json': {
        schema: z.object({
          message: z.string().openapi({
            example: 'Internal Server Error',
          }),
        }),
      },
    },
  },
}

export const posts = {
  postPosts: createRoute({
    tags: ['Post'],
    method: 'post',
    path: '/posts',
    description: 'Create a new post',
    request: {
      body: {
        required: true,
        content: {
          'application/json': {
            schema: postSchema.pick({
              post: true,
            }),
          },
        },
      },
    },
    responses: {
      ...createdResponse,
      ...badRequestResponse,
      ...internalServerErrorResponse,
    },
  }),
  getPosts: createRoute({
    tags: ['Post'],
    method: 'get',
    path: '/posts',
    description: 'get PostList posts with optional pagination',
    request: {
      query: z.object({
        page: z.string(),
        limit: z.string(),
      }),
    },
    responses: {
      200: {
        description: 'OK',
        content: {
          'application/json': {
            schema: z.array(postSchema),
          },
        },
      },
      ...badRequestResponse,
      ...internalServerErrorResponse,
    },
  }),
  putPosts: createRoute({
    tags: ['Post'],
    method: 'put',
    path: '/posts/{id}',
    description: 'update Post',
    request: {
      params: z.object({
        id: z.string().uuid(),
      }),
      body: {
        required: true,
        content: {
          'application/json': {
            schema: postSchema.pick({ post: true }),
          },
        },
      },
    },
    responses: {
      ...NoContentResponse,
      ...badRequestResponse,
      ...internalServerErrorResponse,
    },
  }),
  deletePosts: createRoute({
    tags: ['Post'],
    method: 'delete',
    path: '/posts/{id}',
    description: 'delete post',
    request: {
      params: z.object({
        id: z.string().uuid(),
      }),
    },
    responses: {
      ...NoContentResponse,
      ...badRequestResponse,
      ...internalServerErrorResponse,
    },
  }),
}
```
:::

## Grouping routes for RPC

* [Grouping routes for RPC](https://hono.dev/examples/grouping-routes-rpc)

:::code-group
```ts [app/core/index.ts]
import { OpenAPIHono } from '@hono/zod-openapi'
import { basicAuth } from 'hono/basic-auth'
import { HonoXHandler } from './handler/honox_handler'
import { PostsHandler } from './handler/posts_handler'
import { SwaggerHandler } from './handler/swagger_handler'

export class App {
  private static username = process.env.SWAGGER_USER
  private static password = process.env.SWAGGER_PASSWORD
  static init() {
    const app = new OpenAPIHono()
    if (this.username && this.password) {
      app.use('/auth/*', basicAuth({ username: this.username, password: this.password }))
    }
    return this.applyRoutes(app)
  }

  static applyRoutes(app: OpenAPIHono) {
    return app
      .route('/', HonoXHandler.apply(app))
      .route('/', PostsHandler.apply(app))
      .route('/', SwaggerHandler.apply(app))
  }
}
```
:::

## Swagger UI

* [Swagger UI](https://hono.dev/examples/swagger-ui)

:::code-group
```ts [app/core/handler/swagger_handler.ts]
import { swaggerUI } from '@hono/swagger-ui'
import { OpenAPIHono } from '@hono/zod-openapi'

export class SwaggerHandler {
  static apply(app: OpenAPIHono) {
    return app
      .doc('/auth/doc', {
        info: {
          title: 'HonoXüî• API',
          version: 'v1',
        },
        openapi: '3.1.0',
        servers: [
          {
            url: '/api',
            description: 'API base path',
          },
        ],
        tags: [
          {
            name: 'HonoXüî•',
            description: 'HonoXüî• API',
          },
          {
            name: 'Post',
            description: 'Post API',
          },
        ],
      })
      .get('/auth/ui', swaggerUI({ url: '/api/auth/doc' }))
  }
}
```
:::


## Access Browser

```
http://localhost:5173/api/auth/ui
```

![img](img/01.png)


:::code-group
```ts [app/core/handler/honox_handler.ts]
import { OpenAPIHono } from '@hono/zod-openapi'
import { routes } from '../openapi'

export class HonoXHandler {
  static apply(app: OpenAPIHono) {
    return app.openapi(routes.HonoX, async (c) => {
      return c.json({ message: 'HonoXüî•' })
    })
  }
}
```
:::

:::code-group
```ts [app/core/handler/posts_handler.ts]
import { OpenAPIHono } from '@hono/zod-openapi'
import { Post } from '@prisma/client'
import { routes } from '../openapi'
import { PostService } from '../service/posts_service'

export class PostsHandler {
  static apply(app: OpenAPIHono) {
    return app
      .openapi(routes.postPosts, async (c) => {
        try {
          const { post } = c.req.valid('json')
          await PostService.createPost(post)
          return c.json({ message: 'Created' }, 201)
        } catch {
          return c.json({ message: 'Internal Server Error' }, 500)
        }
      })
      .openapi(routes.getPosts, async (c) => {
        try {
          const { page, limit } = c.req.valid('query')
          const pageNumber = parseInt(page)
          const perPage = parseInt(limit)
          if (isNaN(pageNumber) || isNaN(perPage) || pageNumber < 1 || perPage < 1) {
            return c.json({ message: 'Bad Request' }, 400)
          }
          const posts: Post[] = await PostService.getPosts(pageNumber, perPage)
          return c.json(posts, 200)
        } catch {
          return c.json({ message: 'Internal Server Error' }, 500)
        }
      })
      .openapi(routes.putPosts, async (c) => {
        try {
          const { id } = c.req.valid('param')
          const json_valid = c.req.valid('json')
          const { post } = json_valid
          await PostService.putPost(id, post)
          return new Response(null, { status: 204 })
        } catch {
          return c.json({ message: 'Internal Server Error' }, 500)
        }
      })
      .openapi(routes.deletePosts, async (c) => {
        try {
          const { id } = c.req.valid('param')
          await PostService.deletePost(id)
          return new Response(null, { status: 204 })
        } catch {
          return c.json({ message: 'Internal Server Error' }, 500)
        }
      })
  }
}
```
:::

## Hono RPC

* [Ë¶ã„Çà„ÄÅ„Åì„Çå„ÅåHono„ÅÆRPC„Å†](https://zenn.dev/yusukebe/articles/a00721f8b3b92e)

:::code-group
```ts [app/routes/api.ts]
import { hc } from 'hono/client'
import { App } from '../core'

const app = App.init()
export type AddType = typeof app
export const client = hc<AddType>('/api')
export default app
```
:::

## Client Components

* [Client Components](https://hono.dev/docs/guides/jsx-dom)

* [css Helper](https://hono.dev/docs/helpers/css)

![img](img/02.png)